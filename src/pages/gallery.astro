---
import Layout from '@/layouts/Layout.astro';
import { GET as GetGalleryAssets } from './gallery-assets';
import { GET as GetFolderAssets } from './[folderId].folder-assets';
import StoryblokComponent from '@storyblok/astro/StoryblokComponent.astro';
import { useStoryblokGet } from '@/utils';
import type { Asset, GalleryData } from '@/types';
import type { GalleryPhotoshootStoryblok } from '@/component-types';

const { data } = await useStoryblokGet('cdn/stories/gallery');

const response = await GetGalleryAssets(Astro);

if (!response.ok) {
    throw new Error('Network response was not ok');
}

const galleryData: GalleryData = await response.json();

const assets: {
    name: string;
    assets: Asset[];
}[] = await Promise.all(
    galleryData.asset_folders.map(async (folder) => {
        const response = await GetFolderAssets({
            ...Astro,
            params: {
                folderId: folder.id,
            },
        });

        if (!response.ok) {
            throw new Error('Network response was not ok');
        }

        const resData = await response.json();

        return {
            name: folder.name,
            assets: resData.assets,
        };
    })
);
---

<Layout title="Gallery">
    <!-- todo: this will be removed once the navbar is refactored -->
    <StoryblokComponent blok={data.story.content} />
    <div class="flex flex-col gap-16 p-4 sm:p-16 mt-28 sm:mt-16">
        {
            (data.story.content.events as GalleryPhotoshootStoryblok[])
                ?.sort(
                    (a, b) =>
                        // sort the dates in descending order
                        new Date(b.date).getTime() - new Date(a.date).getTime()
                )
                .map((event) => (
                    <div class="flex flex-col gap-4">
                        <div class="flex flex-col gap-2 sm:flex-row sm:gap-6 items-center">
                            <div class="hidden sm:flex w-3 h-3 rounded-full bg-gray-200" />
                            <span class="text-xl sm:text-3xl font-semibold">
                                {event.name}
                            </span>
                            <div class="hidden sm:flex w-20 bg-gray-200 h-[1px]" />
                            <span class="text-base text-gray-500">
                                {new Date(event.date).toLocaleDateString(
                                    'en-US',
                                    {
                                        year: 'numeric',
                                        month: 'long',
                                        day: 'numeric',
                                    }
                                )}
                            </span>
                        </div>
                        <div class="flex flex-row gap-9">
                            <div class="hidden sm:flex w-9 relative">
                                <div class="absolute inset-y-0 left-[5.5px] w-[1px] bg-gray-200" />
                            </div>
                            <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">
                                {assets
                                    .find(
                                        (asset) =>
                                            asset.name === event.folder_name
                                    )
                                    ?.assets.map((image) => (
                                        <div class="relative aspect-square">
                                            <a
                                                href={image.filename}
                                                target="_blank"
                                            >
                                                <img
                                                    src={image.filename}
                                                    alt={image.filename}
                                                    class="object-cover w-full h-full rounded-xl hover:brightness-90"
                                                />
                                            </a>
                                        </div>
                                    ))}
                            </div>
                        </div>
                    </div>
                ))
        }
    </div>
</Layout>
